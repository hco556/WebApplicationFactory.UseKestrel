trigger:
  branches:
    include:
      - main

variables:
  # Set these in the pipeline UI or replace with your values
  # azureSubscription: '$(azureSubscription)'
  # containerRegistryServiceConnection: '$(containerRegistryServiceConnection)'
  # acrName: 'myAcrName'
  # acrLoginServer: 'myacr.azurecr.io'
  imageName: 'wafdemo-web'
  imageTag: '$(Build.BuildId)'
  # resourceGroup: 'myResourceGroup'
  # appName: 'myAppServiceName'

stages:
  - stage: CI
    displayName: Continuous Integration
    jobs:
      - job: BuildAndTest
        displayName: Build and Test
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: UseDotNet@2
            displayName: 'Install .NET SDK'
            inputs:
              packageType: 'sdk'
              version: '10.0.x'
              includePreviewVersions: true

          - script: |
              dotnet restore
            displayName: 'dotnet restore'

          - script: |
              dotnet build --configuration Release --no-restore
            displayName: 'dotnet build'

          - script: |
              # Install Playwright CLI globally as a .NET tool (compatible with .NET 10)
              dotnet tool install --global Microsoft.Playwright.CLI || dotnet tool update --global Microsoft.Playwright.CLI || true
              export PATH="$HOME/.dotnet/tools:$PATH"
              # Install Playwright browsers required by Playwright for .NET tests
              playwright install --with-deps
            displayName: 'Install Playwright and browsers'

          - script: |
              dotnet test --configuration Release --no-build --logger trx
            displayName: 'Run tests'

  # - stage: CD
  #   displayName: Continuous Deployment
  #   dependsOn: CI
  #   condition: succeeded()
  #   jobs:
  #     - deployment: BuildAndPushAndDeploy
  #       displayName: Build, Push Docker image and Deploy
  #       environment: 'production'
  #       pool:
  #         vmImage: 'ubuntu-latest'
  #       strategy:
  #         runOnce:
  #           deploy:
  #             steps:
  #               - checkout: self

  #               - task: UseDotNet@2
  #                 displayName: 'Install .NET SDK'
  #                 inputs:
  #                   packageType: 'sdk'
  #                   version: '10.0.x'
  #                   includePreviewVersions: true

  #               - task: Docker@2
  #                 displayName: Build and push image to ACR
  #                 inputs:
  #                   containerRegistry: '$(containerRegistryServiceConnection)'
  #                   repository: '$(acrLoginServer)/$(imageName)'
  #                   command: 'buildAndPush'
  #                   Dockerfile: 'BlazorWebApp/Dockerfile'
  #                   buildContext: '$(Build.SourcesDirectory)'
  #                   tags: |
  #                     $(imageTag)

  #               - task: AzureCLI@2
  #                 displayName: 'Configure App Service to use ACR image'
  #                 inputs:
  #                   azureSubscription: '$(azureSubscription)'
  #                   scriptType: bash
  #                   scriptLocation: inlineScript
  #                   inlineScript: |
  #                     set -e
  #                     echo "Logging into ACR: $(acrName)"
  #                     az acr login --name $(acrName)

  #                     echo "Configuring web app: $(appName) to use image: $(acrLoginServer)/$(imageName):$(imageTag)"
  #                     az webapp config container set --name $(appName) --resource-group $(resourceGroup) --docker-custom-image-name $(acrLoginServer)/$(imageName):$(imageTag)

  #                     echo "Restarting web app"
  #                     az webapp restart --name $(appName) --resource-group $(resourceGroup)
